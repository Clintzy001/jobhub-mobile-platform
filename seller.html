<!DOCTYPE html>
<html lang="en" id="htmlTag">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Profile | KHUB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --brand: #4A148C; }
        body { background-color: #F9F9F9; transition: 0.3s; font-family: sans-serif; }
        .dark body { background-color: #000; color: white; }
        .brand-gradient { background: linear-gradient(135deg, #4A148C 0%, #2E0B5B 100%); }
        .star-rating i { cursor: pointer; transition: 0.2s; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-20">

    <div class="brand-gradient p-6 pb-20 rounded-b-[40px] relative">
        <div class="flex justify-between items-center text-white mb-4">
            <button onclick="history.back()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1 class="font-black uppercase text-xs tracking-widest">Seller Profile</h1>
            <div class="w-10"></div>
        </div>
    </div>

    <div class="px-6 -mt-14">
        <div class="bg-white dark:bg-zinc-900 rounded-[35px] p-6 shadow-xl text-center border dark:border-zinc-800">
            <div class="relative inline-block">
                <img id="sellerImg" src="" class="w-24 h-24 rounded-full border-4 border-white dark:border-zinc-800 shadow-lg object-cover mx-auto">
                <i class="fas fa-check-circle text-blue-500 absolute bottom-0 right-0 text-2xl bg-white rounded-full"></i>
            </div>
            
            <h2 id="sellerName" class="text-xl font-black uppercase mt-4 dark:text-white">Loading...</h2>
            <p id="sellerLoc" class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter mb-2"></p>
            
            <div class="flex justify-center items-center gap-1 text-yellow-400 text-xs">
                <i class="fas fa-star"></i>
                <span id="avgRatingText" class="text-gray-700 dark:text-gray-300 font-black ml-1">5.0</span>
                <span id="totalReviewsText" class="text-gray-400 font-bold ml-1">(0 Reviews)</span>
            </div>

            <div class="flex gap-2 mt-6">
                <button id="whatsappBtn" class="flex-1 bg-[#25D366] text-white py-4 rounded-2xl font-black uppercase text-[10px] shadow-lg">
                    <i class="fab fa-whatsapp mr-2"></i> Contact
                </button>
                <button onclick="toggleReviewModal()" class="flex-1 bg-brand text-white py-4 rounded-2xl font-black uppercase text-[10px] shadow-lg">
                    <i class="fas fa-star mr-2"></i> Rate Seller
                </button>
            </div>
        </div>
    </div>

    <div id="reviewModal" class="hidden px-6 mt-6">
        <div class="bg-purple-50 dark:bg-zinc-800/50 p-5 rounded-[30px] border border-brand/20">
            <h4 class="text-[10px] font-black uppercase mb-3 text-brand dark:text-purple-400">Write a Review</h4>
            <div class="star-rating flex gap-2 text-xl text-gray-300 mb-4" id="starInput">
                <i class="fas fa-star" onclick="setStar(1)"></i>
                <i class="fas fa-star" onclick="setStar(2)"></i>
                <i class="fas fa-star" onclick="setStar(3)"></i>
                <i class="fas fa-star" onclick="setStar(4)"></i>
                <i class="fas fa-star" onclick="setStar(5)"></i>
            </div>
            <textarea id="reviewText" placeholder="How was your experience?" class="w-full p-4 rounded-2xl text-xs bg-white dark:bg-zinc-900 border-none outline-none mb-3" rows="2"></textarea>
            <button onclick="submitReview()" class="w-full py-3 bg-brand text-white rounded-xl font-black uppercase text-[10px]">Submit Feedback</button>
        </div>
    </div>

    <main class="px-6 mt-10">
        <h3 class="font-black text-sm uppercase mb-5 tracking-tighter dark:text-white">Store Catalog</h3>
        <div id="sellerGrid" class="grid grid-cols-2 gap-4 mb-10"></div>

        <h3 class="font-black text-sm uppercase mb-5 tracking-tighter dark:text-white">Customer Reviews</h3>
        <div id="reviewsList" class="space-y-4">
            </div>
    </main>

    <script>
        const _supabase = supabase.createClient('YOUR_URL', 'YOUR_KEY');
        let currentRating = 0;
        let currentSellerId = null;

        const sellers = [
            {id: 1, name: "A.A Rano Gadgets", location: "Zaria Road, Kano", wa: "2347051337399", img: "https://ui-avatars.com/api/?name=AA&background=FFAB00&color=fff"},
            {id: 2, name: "Sahad Store", location: "Zoo Road, Kano", wa: "2347051337399", img: "https://ui-avatars.com/api/?name=SS&background=4A148C&color=fff"}
        ];

        async function initSeller() {
            const urlParams = new URLSearchParams(window.location.search);
            currentSellerId = urlParams.get('id');
            const seller = sellers.find(s => s.id == currentSellerId);

            if (seller) {
                document.getElementById('sellerName').innerText = seller.name;
                document.getElementById('sellerLoc').innerText = seller.location;
                document.getElementById('sellerImg').src = seller.img;
                document.getElementById('whatsappBtn').onclick = () => window.open(`https://wa.me/${seller.wa}`);
                
                loadInventory(seller.name);
                renderReviews();
            }
        }

        async function loadInventory(name) {
            const { data } = await _supabase.from('market').select('*').eq('seller_name', name);
            const grid = document.getElementById('sellerGrid');
            if(data && data.length > 0) {
                grid.innerHTML = data.map(p => `
                    <div class="bg-white dark:bg-zinc-900 p-3 rounded-[25px] shadow-sm border dark:border-zinc-800">
                        <img src="${p.image_url}" class="w-full h-28 object-cover rounded-2xl mb-2">
                        <h4 class="text-[9px] font-bold uppercase truncate dark:text-white">${p.name}</h4>
                        <div class="text-green-600 font-black text-xs">â‚¦${p.price}</div>
                    </div>
                `).join('');
            } else {
                grid.innerHTML = '<p class="col-span-2 text-center opacity-30 uppercase font-bold text-xs py-10">No items listed</p>';
            }
        }

        // --- REVIEW SYSTEM LOGIC ---

        function toggleReviewModal() {
            document.getElementById('reviewModal').classList.toggle('hidden');
        }

        function setStar(n) {
            currentRating = n;
            const stars = document.getElementById('starInput').children;
            for(let i=0; i<5; i++) {
                stars[i].classList.toggle('text-yellow-400', i < n);
                stars[i].classList.toggle('text-gray-300', i >= n);
            }
        }

        function submitReview() {
            const text = document.getElementById('reviewText').value;
            if (currentRating === 0) return alert("Please select a star rating");
            
            const newReview = {
                sellerId: currentSellerId,
                stars: currentRating,
                comment: text || "Satisfied customer!",
                date: new Date().toLocaleDateString()
            };

            // Save to LocalStorage (For demo)
            let reviews = JSON.parse(localStorage.getItem('khub_reviews')) || [];
            reviews.push(newReview);
            localStorage.setItem('khub_reviews', JSON.stringify(reviews));

            // Reset UI
            document.getElementById('reviewText').value = "";
            setStar(0);
            toggleReviewModal();
            renderReviews();
        }

        function renderReviews() {
            let reviews = JSON.parse(localStorage.getItem('khub_reviews')) || [];
            // Filter reviews for THIS seller only
            const sellerReviews = reviews.filter(r => r.sellerId == currentSellerId);
            const container = document.getElementById('reviewsList');
            
            if (sellerReviews.length === 0) {
                container.innerHTML = '<p class="text-[10px] text-gray-400 italic">No reviews yet. Be the first!</p>';
                return;
            }

            // Calculate average
            const avg = (sellerReviews.reduce((acc, r) => acc + r.stars, 0) / sellerReviews.length).toFixed(1);
            document.getElementById('avgRatingText').innerText = avg;
            document.getElementById('totalReviewsText').innerText = `(${sellerReviews.length} Reviews)`;

            container.innerHTML = sellerReviews.reverse().map(r => `
                <div class="bg-white dark:bg-zinc-900 p-4 rounded-2xl border dark:border-zinc-800 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-yellow-400 text-[10px]">
                            ${'<i class="fas fa-star"></i>'.repeat(r.stars)}
                        </div>
                        <span class="text-[8px] text-gray-400 font-bold uppercase">${r.date}</span>
                    </div>
                    <p class="text-[11px] text-gray-600 dark:text-gray-300 leading-relaxed italic">"${r.comment}"</p>
                </div>
            `).join('');
        }

        if(localStorage.getItem('khub_theme') === 'dark') document.getElementById('htmlTag').classList.add('dark');
        window.onload = initSeller;
    </script>
</body>
</html>
